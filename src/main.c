#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

// 180-byte header for GBTD 2.2
uint8_t gbr_header[180] = {
	0x47, 0x42, 0x4f, 0x30, 0x01, 0x00, 0x00, 0x00,
	0x78, 0x00, 0x00, 0x00, 0x47, 0x61, 0x6d, 0x65,
	0x62, 0x6f, 0x79, 0x20, 0x54, 0x69, 0x6c, 0x65,
	0x20, 0x44, 0x65, 0x73, 0x69, 0x67, 0x6e, 0x65,
	0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x32, 0x2e, 0x32, 0x00, 0x1d, 0x01,
	0x02, 0x00, 0x00, 0x00, 0x48, 0x6f, 0x6d, 0x65,
	0x3a, 0x20, 0x77, 0x77, 0x77, 0x2e, 0x63, 0x61,
	0x73, 0x65, 0x6d, 0x61, 0x2e, 0x6e, 0x65, 0x74,
	0x2f, 0x7e, 0x68, 0x70, 0x6d, 0x75, 0x6c, 0x64,
	0x65, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x00,
	0x28, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x80, 0x00,
	0x00, 0x01, 0x02, 0x03
};

void unpack_tile(uint8_t* in_2bpp, uint8_t* out_raw) {
    for (int row = 0; row < 8; row++) {
        uint8_t low = in_2bpp[row * 2];
        uint8_t high = in_2bpp[row * 2 + 1];
        // each row -> 8 pixels wide
        for (int bit = 0; bit < 8; bit++) {
            int shift = 7 - bit;
            out_raw[row * 8 + bit] = ((low >> shift) & 0x01) | (((high >> shift) & 0x01) << 1);
        }
    }
}

int main(int argc, char* argv[]) {
    if (argc < 2) {
        printf("Usage: %s <input.c>\n", argv[0]);
        return 1;
    }

    FILE* f_in = fopen(argv[1], "r");
    if (!f_in) return 1;

    // skip all until '{'
    int ch;
    while ((ch = fgetc(f_in)) != EOF && ch != '{');

    // read the hex in the buff
    uint8_t hardware_bytes[8192]; // Max 512 tiles
    int byte_count = 0;
    unsigned int val;

    while (fscanf(f_in, " 0x%x ,", &val) == 1) {
        hardware_bytes[byte_count++] = (uint8_t)val;
    }
    fclose(f_in);

    // create .GBR
    FILE* f_out = fopen("output/output.gbr", "wb");
    fwrite(gbr_header, 1, 180, f_out); // write header

    // convert 16 bytes .C tiles -> 64 bytes .GBR
    uint8_t gbr_tile[64];
    for (int i = 0; i < byte_count; i += 16) {
        unpack_tile(&hardware_bytes[i], gbr_tile);
        fwrite(gbr_tile, 1, 64, f_out); // write actual data
    }

    fclose(f_out);
    printf("Converted %d bytes into %d tiles in 'output.gbr'\n", byte_count, byte_count / 16);
    return 0;
}